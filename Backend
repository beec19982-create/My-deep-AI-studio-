from flask import Flask, request, jsonify
from transformers import pipeline
import os
import moviepy.editor as mp
import subprocess

app = Flask(__name__)

# Load Hugging Face models
codegen = pipeline("text-generation", model="huggingface/CodeGen")  # Model for code generation
imagegen = pipeline("text-to-image-generation", model="CompVis/stable-diffusion-v-1-4-original")  # Image generation model

@app.route('/generate_app', methods=['POST'])
def generate_app():
    # Get user input (prompt) for generating app
    prompt = request.json.get("prompt")
    
    # Generate backend (Flask) and frontend (React) code based on user input
    generated_code = codegen(prompt, max_length=1500, num_return_sequences=1)[0]['generated_text']
    
    # Save the generated code (Frontend and Backend)
    os.makedirs("generated_app/frontend", exist_ok=True)
    os.makedirs("generated_app/backend", exist_ok=True)
    
    with open("generated_app/frontend/App.js", "w") as f:
        f.write(generated_code)  # Save generated frontend (React code)
    
    with open("generated_app/backend/app.py", "w") as f:
        f.write(generated_code)  # Save generated backend (Flask code)
    
    # Example response
    return jsonify({"status": "App Generated", "frontend_code": generated_code, "backend_code": generated_code})


@app.route('/swap_faces', methods=['POST'])
def swap_faces():
    # Get the uploaded source and target video files
    source_video = request.files['source_video']
    target_video = request.files['target_video']
    
    # Placeholder for face swap functionality (you would use DeepFake or similar model here)
    result_video = "output_video.mp4"  # Placeholder for result video
    
    # Perform face swap (moviepy is used as a placeholder)
    result_video_path = "output_video.mp4"
    source_clip = mp.VideoFileClip(source_video)
    target_clip = mp.VideoFileClip(target_video)
    source_clip.write_videofile(result_video_path)
    
    return jsonify({"status": "Face swap completed", "result_video": result_video_path})


@app.route('/generate_image', methods=['POST'])
def generate_image():
    # Get the user input (prompt) for generating an image
    prompt = request.json.get("prompt")
    
    # Generate image using Hugging Face model (Stable Diffusion or DALLÂ·E)
    generated_image = imagegen(prompt)[0]['image']
    
    # Save the generated image
    image_path = "generated_image.png"
    generated_image.save(image_path)
    
    return jsonify({"status": "Image Generated", "image_path": image_path})


@app.route('/deploy_app', methods=['POST'])
def deploy_app():
    # Deploy the generated app using Docker (as an example)
    try:
        # Dockerizing the application (both frontend and backend)
        subprocess.run(["docker", "build", "-t", "generated_app", "."])
        subprocess.run(["docker", "run", "-d", "-p", "5000:5000", "generated_app"])
        
        # Return deployment success response
        return jsonify({"status": "App deployed successfully"})
    except Exception as e:
        return jsonify({"status": "Deployment failed", "error": str(e)})


if __name__ == '__main__':
    app.run(debug=True)
